---
title: "Zeespiegelmonitor"
author: "Willem Stolte, Nathalie Dees"
date: "2024-03-12"
output:
  html_document:
    df_print: paged
    code_folding: hide
  github_document:
    code_folding: hide
params:
  monitoryear: 2024
  wind_or_surge_type: GTSM
  station:
  # - Delfzijl
  # - Harlingen
  # - Den Helder
  # - IJmuiden
  # - Hoek van Holland
  # - Vlissingen
  # - Netherlands
  - Netherlands (without Delfzijl)
  modeltype:
  # - linear
   - broken_linear
   # - broken_squared
---


## Inleiding

De zeespiegelmonitor bepaalt voor elk jaar de stand van zaken rond de zeespiegel aan de Nederlandse kust. Het bevat primair de indicatoren gemiddelde zeespiegel en zeespiegelstijging.

Zeespiegelgegevens worden verzameld door Rijkswaterstaat en jaarlijks doorgegeven aan de Permanent Service for Mean Sea Level ([PSMSL](https://www.psmsl.org)). Deze gegevens zijn de basis voor de Zeespiegelmonitor. 


```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  comment=FALSE,
  message=FALSE,
  warning = FALSE
)

require(leaflet)
require(plotly)
require(nlme)

config <- RcppTOML::parseToml("_common/configuration.TOML")
source("_common/functions.R")
source("_common/plotfunctions.R")
epoch = config$constants$epoch
mainstations_df <- readMainStationInfo(filepath = "../../")
mainstations_locs <- readMainStationLocations(path = "../../")
nstations = length(params$station)
nmodels  = length(params$modeltype)
nsurge  = length(params$wind_or_surge_type)

```


```{r readData, comment=F, message=F}

# df <- readSeaLevelData(file.path("../", config$constants$dataUrl)) %>%
  df <- read_csv2(file.path("../", "../data/deltares/results/dutch-sea-level-monitor-export-stations-latest.csv")) %>%
  filter(
    station %in% params$station
  ) %>%
  filter(year >= 1890)

```

### Zeespiegelmetingen

Maandelijks en jaarlijks gemiddelde waterhoogtegegevens worden ingelezen via [PSMSL](https://psmsl.org/data/obtaining/) voor de Nederlandse hoofdstations. PSMSL geeft waterhoogtes ten opzichte van "revised local reference". Deze moet per station worden teruggerekend naar waterhoogte t.o.v. NAP 2005, waarna de waterhoogtes per jaar worden gemiddeld over de stations `r if(params$station == "Netherlands (without Delfzijl)"){c("Harlingen", "Den Helder", "IJmuiden", "Hoek van Holland", "Vlissingen")} `. Station Delfzijl wordt op dit moment niet meegenomen omdat het een aantal jaren niet gekoppeld is geweest aan het NAP referentievlak. De verkregen gemiddelde waterhoogte over de laatste 10 jaren is te zien in tabel \@ref(tab:metingenView).

```{r metingenView}
df %>% 
  arrange(year) %>%
  select(year, 
         `height in mm`  = height, 
         station) %>%
  tail(10) %>%
  kableExtra::kable(caption = "Zeespiegelhoogte in mm over de laatste 10 jaar")
```



### Windopzet

Windopzet wordt berekend met het Global Tide and Surge Model (GTSM) en wordt gebruikt om de variatie in het zeespiegelsignaal ten gevolge van windopzet zo veel mogelijk weg te nemen. 

```{r metingenView2}
df %>% 
  arrange(year) %>%
  select(year, 
         `opzetanomalie in mm`  = surge_anomaly, 
         station) %>%
  tail(10) %>%
  mutate(`opzetanomalie in mm` = signif(`opzetanomalie in mm`, 2)) %>%
  kableExtra::kable(caption = "Opzetanomalie (de afwijking in opzet van het langjarige gemiddelde) berekend door GTSM in mm over de laatste 10 jaar")
```

Het GTSM model wordt elk jaar bijgewerkt, en de jaargemiddelde opzet door wind en luchtdruk uit dit model worden gebruikt om de variatie veroorzaakt door windopzet van de jaargemiddelde zeespiegel af te trekken. Hierdoor kan er preciezer een schatting van de trend en eventueel een trendbreuk worden gevonden. Voor de trendberekening wordt de opzetanomalie gebruikt, dat is de opzet per jaar, gedeeld door de gemiddelde opzet over de hele periode.

## Keuze van stations

De Zeespiegelmonitor heeft als doel om een overzicht te geven van de zeespiegel en -stijging voor de gehele Nederlandse kust. Hiervoor worden in principe de 6 hoofdstations gemiddeld. In de Zeespiegelmonitor (2023) is geconstateerd dat de waarden voor Delfzijl de laatste 15-20 jaar niet aan dezelfde standaard voldoen als voor de overige stations. in de tussentijd zijn correcties uitgevoerd voor deze meetwaarden. Deze zijn nog niet in deze Zeespiegelmonitor opgenomen. Op dit moment wordt dus gerekend met de vijf resterende stations. We noemen dit virtuele station `r params$station`. 


## Is er een versnelling?

Om de zeespiegelstijging over de laatste 10-15 jaar correct te berkenen kan het noodzakelijk zijn om te kiezen voor een model dat op enige wijze een verandering (versnelling) van de zeespiegel laat zien (Zeepspiegelmonitor 2023). In het rekendocument "Sealevelanalysis" is uitgezocht welk model het voorkeursmodel is voor de bepaling van de huidige zeespiegelstijging. Op dit moment worden de volgende modellen getest:

- lineair model (geen versnelling)
- gebroken lineair model (met breekpunt in 1993)
- gebroken kwadratisch model (met breekpunt in 1960)

De keuze voor model wordt gedaan op basis van 3 criteria:

- Er moet een significant betere fit zijn t.o.v. het meest simpele model (lineair)
- De versnellingsterm moet significant zijn
- De AIC waarde is lager dan van de overige modellen

Uit het analysedocument is gebleken:

```{r preferedModel, results='asis'}
selectedmodel <- params$modeltype
cat("Het voorkeursmodel voor de bepaling van de huidige zeespiegelstijging is het ", selectedmodel, " model.")
```
In dit rekendocument wordt daarom gerekend met de gegevens van het (virtuele) station `r params$station` en het `r params$modeltype` modeltype. 

```{r nest-per-station}
byStation <- df %>%
  dplyr::group_by(station) %>%
  tidyr::nest() %>%
  dplyr::ungroup()
```



```{r producemodels}

selectedmodel <- params$modeltype

models <- byStation %>%
  expand_grid(modeltype = selectedmodel) %>%
  mutate(modelfunctionname = paste(modeltype, "model", sep = "_")) %>%
  # add functions for model calculation
  mutate(modelfunctions = map(modelfunctionname, get)) %>%
  # add models based on data and functions
  mutate(model = pmap(
    list(
      data,
      modelfunctions
    ),
    \(.d, .f) .f(.d)
  )) %>%
  mutate(
    glance = map(model, broom::glance),
    rsq    = glance %>% map_dbl("r.squared"),
    adj.rsq = glance %>% map_dbl("adj.r.squared"),
    AIC    = glance %>% map_dbl("AIC"),
    tidy   = map(model, broom::tidy),
    augment = map(model, broom::augment),
    equation = map(model, function(x) equatiomatic::extract_eq(x))
  )


```

### Omgaan met autocorrelatie

Er is een consistente autocorrelatie met een 'lag' van 1 jaar (zie rekendocument Sealevelanalysis). Het is niet ongebruikelijk voor lange tijdseries die een trend vertonen. Hierdoor kan niet alle variatie worden toegekend aan het model zelf, en moet de standaardfout van de modelparameters worden gecorrigeerd voor de autocorrelatie. Dit gebeurt met een [Newey West autocorrelatieterm](https://search.r-project.org/CRAN/refmans/sandwich/html/NeweyWest.html).


```{r add-HAC}
# Using NeweyWest():
require(sandwich)

models <- models %>%
  mutate(
    tidy.HAC = map(
      model, 
      function(x) broom::tidy(
        sqrt(
          diag(
            NeweyWest(
              x, 
              lag = 1, 
              prewhite = F, 
              adjust = T
            )
          )
        )
      )
    )
  )
    
  models$tidy.HAC <- lapply(models$tidy.HAC,
       function(x) {
         x %>%
           rename(
             term.HAC = names,
             st.err.HAC = x
           )
       }
)

```


## Heteroskedasticity

Er wordt gecontroleerd of de verdeling van de residuen regelmatig is verdeeld over de tijd en over de te schatten waarde. 

### Residuals distribution

```{r, fig.height=nstations*1.5+1, fig.width=nmodels*2+1, fig.align='center', fig.cap="De verdeling (histogram) van de residuen. "}

models %>%
  unnest(c(data, augment), names_sep = "_") %>%
ggplot(aes(x = augment_.resid)) +
  geom_histogram(bins = 20, stat = ) +
                  facet_grid(station ~ modeltype)

```


## Variation of residuals over time

Bij een geschikt model verwachten we een regelmatige verdeling van residuen over de tijd. Wanneer deze sterk afwijkt dan kan dat een aanwijzing zijn dat het model niet geschikt is, of dat bepaalde correcties niet goed zijn uitgevoerd. 

```{r, fig.height=nstations*1.5+1, fig.width=nmodels*2+1, fig.cap="De verdeling van residuwaarden uitgezet tegen de tijd in jaren. "}
models %>%
  # filter(!grepl("Netherlands", station)) %>%
  # filter(station == "IJmuiden") %>%
  unnest(c(data, augment), names_sep = "_") %>% #str(max.level = 2)
ggplot(aes(data_year, augment_.resid)) +
  geom_point(alpha = 0.4) +
  facet_grid(station ~ modeltype) #+
```



## Sea level rise


```{r}



lookup <- c(
   Constant = "(Intercept)",
    Trend = "I(year - epoch)",
    u_nodal = "I(cos(2 * pi * (year - epoch)/(18.613)))",
    v_nodal = "I(sin(2 * pi * (year - epoch)/(18.613)))",
    `+ trend 1993` = "from1993",
    `+ square_trend 1960` = "from1960_square",
    AR_term = "previousYearHeight"
  )


# data wrangling. move to functions.R

all_predictions <- models %>%
  mutate(
    preds = map2(data, model, add_predictions)
  ) %>%
  dplyr::select(
    station,
    modeltype, 
    data, 
    tidy, 
    preds) %>%
  tidyr::unnest(c(data, preds), names_sep = "_") %>% 
  tidyr::unnest(tidy) %>%
    # str(max.level = 2)

  dplyr::select(-std.error, -statistic, -p.value) %>% # clean up
  tidyr::pivot_wider(
    names_from = term, 
    values_from = estimate
  ) %>%
  mutate(`data_height-surge_anomaly` = data_height - `preds_surge_anomaly`) %>%
  mutate(`preds_height-surge_anomaly` = preds_pred - `preds_surge_anomaly`) %>%
  rename(any_of(lookup)) %>%
  # str(max.level = 2)
  mutate(
    nodal_tide = 
      u_nodal * cos(2*pi*(data_year-epoch)/18.613) + 
      v_nodal * sin(2*pi*(data_year-epoch)/18.613),
    prediction_recalc = case_when(
      if("linear" %in% params$modeltype){
        modeltype == "linear" ~ 
          Constant + 
          Trend * (data_year - epoch)# + 
          # AR_term * data_previousYearHeight
      },
      if("broken_linear" %in% params$modeltype){
        modeltype == "broken_linear" ~ 
          Constant + 
          Trend * (data_year - epoch) +
          # AR_term * data_previousYearHeight +
          (data_year >= 1993) * `+ trend 1993` * (data_year - 1993)
      },
      if("broken_squared" %in% params$modeltype){
        modeltype == "broken_squared" ~ Constant + 
          Trend * (data_year - epoch) +
          (data_year >= 1960) * `+ square_trend 1960` * (data_year - 1960) * (data_year - 1960)
      }
    )
    ) %>%
  select(
    station,
    modeltype,
    data_year,
    data_height,
    preds_year,
    prediction_recalc,
    `data_height-surge_anomaly`,
    `preds_height-surge_anomaly`,
    nodal_tide
  )
```




```{r plotdatauitvoer}

uitvoer_df <- all_predictions %>% 
  mutate(
    `data_height (-nodal -surge anomaly)` = `data_height-surge_anomaly`-nodal_tide,
    `preds_height (-nodal -surge anomaly)` = `preds_height-surge_anomaly`-nodal_tide
  ) %>%
  select(
    station,
    modeltype,
    jaar = data_year,
    `gemeten waterhoogte` = data_height,
    `gecorrigeerde waterhoogte` = `data_height (-nodal -surge anomaly)`,
     `fit`= `preds_height (-nodal -surge anomaly)`
  ) 
# visual check

ggplot(uitvoer_df, aes(x = jaar)) +
  geom_point(aes(y = `gemeten waterhoogte`, color = "gemeten")) +
  geom_point(aes(y = `gecorrigeerde waterhoogte`, color = "gemeten - windopzetanomalie")) +
  geom_line(aes(y = fit, color = "fit")) +
  theme_minimal()

write_csv(uitvoer_df, file = "../../results/plotdata2024.csv")

```


```{r, eval=TRUE}

p <- plot_station(
  stationi = params$station,
    predictions_all = all_predictions %>% 
      filter(station == params$station) %>%
      filter(modeltype == params$modeltype), 
    correctionVariant = params$wind_or_surge_type, 
    modelVariant = params$modeltype, 
    printNumbers = F)

  ggplotly(p) %>% layout(legend = list(x = 0.05, y = 0.95))
  # p
```


```{r, eval=TRUE}

p <- plot_station( 
  stationi = params$station,
    predictions_all = all_predictions %>% 
      filter(station == params$station) %>%
      filter(modeltype == params$modeltype), 
    correctionVariant = params$wind_or_surge_type, 
    modelVariant = params$modeltype, 
    printNumbers = T,
    plotVline = F,
    startyear = 2010)

  ggplotly(p) %>% layout(legend = list(x = 0.05, y = 0.95))
  # p
```


```{r, include=F}
p = plot_station_website(
    stationi = params$station,
    predictions_all = all_predictions %>% 
      filter(station == params$station) %>%
      filter(modeltype == params$modeltype), 
    correctionVariant = params$wind_or_surge_type, 
    modelVariant = params$modeltype, 
    printNumbers = F,
    plotVline = F,
    startyear = 1890)

p

ggsave(paste0("../../results/sl_web_", params$station, params$modeltype, ".png"), width = 8, height = 5)

```




## Trend parameters

For the preferred station `r params$station` and model `r params$modeltype`, the following set of parameters have been found.  

```{r}

library(DT)

lookup.df <- data.frame(long_term = unname(lookup),
                        short_term = names(lookup))

parameterTable <- models %>%
  select(station, modeltype, tidy) %>% 
  unnest(tidy) %>%
  left_join(models %>%
              select(station, modeltype, tidy.HAC) %>%
              unnest(tidy.HAC),
            by = c(
              station = "station",
              modeltype = "modeltype",
              term = "term.HAC"
            )
              ) %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  left_join(lookup.df, by = c(term = "long_term")) %>%
  select(
    short_term,
    estimate,
    st.err.HAC,
    p.value
  )

DT::datatable(parameterTable, caption = "Parameters en standaardfouten voor het voorkeursmodel en -station.",
  options = list(
      "digits" = 2
    )
  )

  # kableExtra::kable(
  #   caption = "Coefficients for all models and stations.",digits = 2
  #   ) %>% 
  # kableExtra::scroll_box(height = "500px")

```
## Conclusies

In 2023 was de gemiddelde zeespiegel `r df$height[df$year==params$monitoryear-1]` mm tov NAP (2005).

Het voorkeursmodel is het *gebroken lineaire* model.

De lineaire trend tot 1993 bedraagt 1.8 +/- 0.1 mm/jaar.

De extra trend na 1993 bedraagt 1.1 +/- 0.3 mm/jaar. 

Na 1993 is de trend verhoogt en bedraagt 2.9 +/- 0.4 mm/jaar.


# Vergelijking met de analyse van vorig jaar.

```{r}
# knitr::include_graphics("../../data/deltares/results/trend2023.jpg")

# knitr::include_url("https://systeemrapportage.nl/zeespiegelmonitor/resultaten.html#tab:zeespiegeltrends", height = "400px")



```

| station | zeespiegel (1970) | trend (voor 1993) | se | trend (vanaf 1993)|
|------:|:------:|:---------:|:-----------:|:----------:|:----------:|
| Netherlands (without Delfzijl) | -39.3 |	1.8 |	0.1 |	2.9 |	0.4 |



